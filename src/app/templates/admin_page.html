<!DOCTYPE html>
{# 
	This is a Jinja2 template for an html page
	These lines are comments and are removed when the template is rendered. 
#}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Blog of Blake Senftner</title>
  <link rel="stylesheet" href="/static/index.css">
</head>
<body>
	<div class="grid">
		{% include 'common_header.html' %}

		{# the left sidebar #}
		{% include 'common_lsidebar.html' %}

		<main>
			<div id="mainContent">
                <h4>Admin Settings for {{ data.username }}</h4>
                <p>Any changes trigger an email notification.</p>
                <label for="email">Change email:</label>
  				<input type="text" id="email" name="label" value="{{data.email}}">
                <br/>
                <label for="email2">Change email again:</label>
                <input type="text" id="email2" name="label" value="{{data.email}}">
                <br/><br/>
                <div id="userMsg">Both fields must match to change.</div>
                <br/>
                <a href="#" class="button" onclick="ChangeEmail()">Change email</a>

                <br/><br/><br/><br/>

                <label for="password">Change password:</label>
  				<input type="password" id="password" name="label" value="">
                <br/>
                <label for="password2">Change password again:</label>
  				<input type="password" id="password2" name="label" value="">
                <br/><br/>
                <div id="userMsg2">Both fields must match to change.</div>
                <br/>
                <a href="#" class="button" onclick="ChangePassword()">Change password</a>

                <br/><br/><br/><br/>

				<div id="userMsg3"><p>This freezes the account from any future activity.</p></div>
                <a href="#" class="button" onclick="DisableAccount()">Disable Account</a>

			</div>
		</main>

		<aside>
			<div id="aside">
				<a href="#" class="button" onclick="Logout()">Logout</a>
			</div>
		</aside>
  
	<footer>
		{{ frags[0].footer | safe }} 
	</footer>
	</div>
	
	<script>

		document.addEventListener("DOMContentLoaded", function() {
			page_init();
		  });
		function page_init() {
			const access_token = localStorage.getItem('token');
			if (!access_token) 
            { window.location.href = "/"; }
            else {
                fetch("/users/me")
                .then(response => response.json())
                .then( response => 
                    {
                        console.log(response)
                        if (!response.hasOwnProperty('username')) {
                            window.location.href = "/";
                        }
                    })
            }
		}


		function ChangeEmail() {
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				// get user data
				const newEmail = document.getElementById("email").value;
				const newEmail2 = document.getElementById("email2").value;
                if (newEmail != newEmail2)
                {
                    document.getElementById("userMsg").innerHTML += 
                        '<h3>Both email fields must match to change your email.</h3>';
                }
                else{
                    document.getElementById("userMsg").innerHTML = "Both fields must match to change.";

                    // post as ordinary text submission:
				    const options = {
					    method: 'POST',
					    headers: {
				  		    'Accept': 'application/json',
				  		    'Content-Type': 'application/json',
					    },
					    body: JSON.stringify( { "text": newEmail } )  
				    };
				    fetch( '/users/setemail/', options )
					    .then( response => response.json() )
					    .then( response => {
						    // Do something with response.
						    console.log( response )
                            document.getElementById("userMsg").innerHTML = 
                                '<p>Email successfully changed.</p>';
					    }); /* */
                }
			}
		}

		function ChangePassword() {
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				// get user data
				const newPassword = document.getElementById("password").value;
				const newPassword2 = document.getElementById("password2").value;
                if (newPassword != newPassword2)
                {
                    document.getElementById("userMsg2").innerHTML += 
                        '<p>Both password fields must match to change your password.</p>';
                }
                else{
                    document.getElementById("userMsg2").innerHTML = '';

                    // post as ordinary text submission:
				    const options = {
					    method: 'POST',
					    headers: {
				  		    'Accept': 'application/json',
				  		    'Content-Type': 'application/json',
					    },
					    body: JSON.stringify( { "text": newPassword } )  
				    };
				    fetch( '/users/setpass/', options )
					    .then( response => response.json() )
					    .then( response => {
						    // Do something with response.
						    // console.log( response )
                            document.getElementById("userMsg2").innerHTML = 
                                '<p>Password successfully changed.<br/>Expect an email with updated account info.</p>';
					    }); /* */
                }
			}
		}


		function DisableAccount() {
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				const options = { 
					method: 'DELETE',
					// headers: { "Authorization": "Bearer " + access_token } // only needed when JWT is not in cookie
				};
				fetch( '/users/disable', options )
					.then( response => response.json() )
					.then( response => {
						// Do something with response:
						console.log( response )
						if (response.id != '1')
						{ 
							console.log( "DELETE ERROR!" )
							alert( "DELETE ERROR!" )
							
						}
						Logout();

					} ); 
			}
			else { alert("Not Authorized.") }
		}

	</script>

	{% include 'common_logout.html' %}


</body>
</html>
