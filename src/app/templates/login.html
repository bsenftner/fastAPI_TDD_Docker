<!DOCTYPE html>
{# 
	This is a Jinja2 template for an html page
	These lines are comments and are removed when the template is rendered. 
#}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Blog of Blake Senftner</title>
  <link rel="stylesheet" href="/static/index.css">
</head>
<body>
	<div class="grid">
		{% include 'common_header.html' %}

		{# the left sidebar #}
		{% include 'common_lsidebar.html' %}

        {# the main content area #}
		<main>
			<div id="mainContent">
				{# a login form #}
            	<h4>Login:</h4>
				<form method="post">
			    	<label for="username">Username:</label>
  			    	<input type="text" id="username" name="label" value="">
                	<br/>
                	<label for="password">Password:</label>
                	<input type="password" id="password" name="label" value="">
                	<br/>
                	<br/>
			    	<div id="divLoginButtons">
				    	<a href="#" class="button" onclick="Cancel()">Cancel</a>
				    	<a href="#" class="button" onclick="Login()">Login</a>
			    	</div>
				</form>
			</div>
		</main>

        {# the right sidebar #}
		<aside>
			<div id="aside">
				<a href="#" class="button" onclick="Register()">Register</a>
			</div>
		</aside>
  
	<footer>
		{{ frags[0].footer | safe }} 
	</footer>
	</div>

	<script>
		
		document.addEventListener("DOMContentLoaded", function() {
			page_init();
		  });
		function page_init() {
			const access_token = localStorage.getItem('token');
			if (access_token) {
				const options = { 
					// headers: { "Authorization": "Bearer " + access_token } // only needed when JWT is not in cookie
				}
				fetch("/users/me", options)
				.then(response => response.json())
				.then( response => 
					{
						console.log(response)
						if (response.hasOwnProperty('username')) {
							document.getElementById("mainContent").innerHTML = 
								"<h4>Welcome back, " + response.username + "</h4>";
							
							document.getElementById("aside").innerHTML = 
								'<a href="#" class="button" onclick="Logout()">Logout</a>';

							if (response.roles.includes('unverified'))
							{
								var newHtml = 
`<h4>Please verify your email:</h4>
 <label for="vcode">Verification code:</label>
 <input type="text" id="vcode" name="label" value="">
 <br/><br/>
 <div id="divLoginButtons">
	<a href="#" class="button" onclick="Cancel()">Cancel</a>
	<a href="#" class="button" onclick="VerifyEmail()">Verify Email</a>
 </div>`
								document.getElementById("mainContent").innerHTML += newHtml
							}
						}
				  })
			}
		}

        function VerifyEmail() { 
			// get the verification code:
			const userVCode = document.getElementById("vcode").value;

			// post:
			const params = { "code": userVCode.trim() };
			//
			const options = {
				method: 'POST',
				headers: {
					  'Accept': 'application/json',
					  'Content-Type': 'application/json',
					  // "Authorization": "Bearer " + access_token // only needed when JWT is not in cookie
				},
				body: JSON.stringify( params )  
			};
			fetch( '/users/verify/', options )
				.then( response => response.json() )
				.then( response => {
					// Do something with response.
					console.log( response )
					if (response.status=='ok')
					{
						document.getElementById("mainContent").innerHTML = 
								"<h4>Email verified, thank you.</h4>";
					}
				}); /* */
		}

        function Cancel() { window.location.href = "/blog/1"; }

		function Register() { window.location.href = "/register"; }
		
		function Login() { 
            
            // get the user's info:
			const loginUser = document.getElementById("username").value;
			const loginPass = document.getElementById("password").value;

            const formData = new FormData();
            formData.append('username', loginUser);
            formData.append('password', loginPass);
            
			const options = { method: 'POST', body: formData };

            fetch('/token', options)
            .then(response => response.text())
            .then(data => { 
                console.log(data);
                const jsonData = JSON.parse(data);
                localStorage.setItem('token', jsonData.access_token);
                window.location.reload();
            });
        }
	</script>

	{% include 'common_logout.html' %}


</body>
</html>
