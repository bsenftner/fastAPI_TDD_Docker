<!DOCTYPE html>
{# 
	This is a Jinja2 template for an html page
	These lines are comments and are removed when the template is rendered. 
#}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Blog of Blake Senftner</title>
  <link rel="stylesheet" href="/static/index.css">

  {# this loads the WYSIWYG Quill Editor's CSS #}
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
	<div class="grid">
		<header>
			{{ frags[0].header | safe }}
		</header>

		<nav>
			{# default links from page_frags.py #}
			{% for alink in frags[0].links %}
				{{ alink | safe }}
			{% endfor %}

			{# not expecting a huge number of blog posts, so here's all of them #}
			{% for post in blogPosts %} 
				<br/><br/><a href="/blog/{{ post.id }}">{{ post.title }}</a>
			{% endfor %}
		</nav>

		<main>
			{# the editor itself, embedded in a form, with a post's contents, and operation buttons #}
			<form method="post">
				<label for="NewPostTitle">Title:</label>
  				<input type="text" id="NewPostTitle" name="label" value="{{contentPost.title}}">
				<div class="editorContainer">
					<div id="editor">
						{{contentPost.description | safe}}
  					</div>
				</div> 
				<div id="divBeneathTheEditor">
					<a href="#" class="button" onclick="BlogEditCancel()">Cancel</a>
					<a href="#" class="button" onclick="BlogUpdate()">Update</a>
					<a href="#" class="button" onclick="BlogDelete()">Delete</a>
					<br/>
					<br/>
					<a href="#" class="button" onclick="BlogSubmit()">Submit A Completely New Blog Post</a>
				</div>
			</form>
		</main>

		<aside>
			<div id="aside">
				<a href="#" class="button" onclick="Login()">Login</a>
			</div>
		</aside>
  
	<footer>
		{{ frags[0].footer | safe }} 
	</footer>
	</div>

	<!-- Include the Quill library -->
	<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
	
	<script>

		document.addEventListener("DOMContentLoaded", function() {
			page_init();
		  });
		function page_init() {
			const access_token = localStorage.getItem('token');
			if (access_token) {
				const options = { 
					// headers: { "Authorization": "Bearer " + access_token } // only needed when JWT is not in cookie
				}
				fetch("/users/me", options)
				.then(response => response.json())
				.then( response => 
					{
						console.log(response)
						if (response.hasOwnProperty('username')) {

							document.getElementById("aside").innerHTML = 
								'<a href="#" class="button" onclick="Logout()">Logout</a>';
						}
						else { window.location.href = "/blog/{{ contentPost.id }}"; }
				  })
			}
			else { window.location.href = "/blog/{{ contentPost.id }}"; }
		}

		// Initialize Quill editor 
		var toolbarOptions = [
  				['bold', 'italic', 'underline', 'strike'],        // toggled buttons
  				['blockquote', 'code-block'],

  				[{ 'header': 1 }, { 'header': 2 }],               // custom button values
  				[{ 'list': 'ordered'}, { 'list': 'bullet' }],
  				[{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
  				[{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
  				[{ 'direction': 'rtl' }],                         // text direction

  				[{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
  				[{ 'header': [1, 2, 3, 4, 5, 6, false] }],

  				[{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
  				[{ 'font': [] }],
  				[{ 'align': [] }],

  				['clean']                                         // remove formatting button
			];
		var quill = new Quill('#editor', {
			modules: {
				toolbar: toolbarOptions
			},
			theme: 'snow'
		});

		function BlogEditCancel() { window.location.href = "/blog/{{ contentPost.id }}"; }

		function BlogSubmit() {
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				// get the post label:
				const newPostTitle = document.getElementById("NewPostTitle").value;
				// Get HTML content
				var newPostHTML = quill.root.innerHTML;

				// post as new blog submission:
				const params = {
					"title": newPostTitle, 
					"description": newPostHTML,
				//	"submitter_id": 1,
				};
			
				const options = {
					method: 'POST',
					headers: {
				  		'Accept': 'application/json',
				  		'Content-Type': 'application/json',
				  		// "Authorization": "Bearer " + access_token // only needed when JWT is not in cookie
					},
					body: JSON.stringify( params )  
				};
				fetch( '/blogposts/', options )
					.then( response => response.json() )
					.then( response => {
						// Do something with response.
						// console.log( response )
						window.location.href = "/blog/" + response.id.toString();
					}); /* */
			}
		}

		function BlogUpdate() {
			
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				// get the post label:
				const newPostTitle = document.getElementById("NewPostTitle").value;
				// Get HTML content
				var newPostHTML = quill.root.innerHTML;

				const someData = {
					"title": newPostTitle, 
					"description": newPostHTML,
				}
			
				const options = {
					method: 'PUT', // Method itself
					headers: {
				 		'Content-type': 'application/json; charset=UTF-8', // Indicates the content 
				 		// "Authorization": "Bearer " + access_token // only needed when JWT is not in cookie
					},
					body: JSON.stringify(someData) // We send data in JSON format
			   	}
			   
			   	// make the HTTP put request using fetch api
			   	fetch('/blogposts/{{ contentPost.id }}', options) 
			   	// .then(response => response.json())
			   	.then(response => 
			   	{
					window.location.href = "/blog/{{ contentPost.id }}";
			   	}) 
			   .catch(err => {
					// Do something with the error
					console.log(err) 
					alert( err )
					window.location.href = "/blog/{{ contentPost.id }}";
				}) 
			}
			else { alert("Not Authorized.") }
		}

		function BlogDelete() {
			const access_token = localStorage.getItem('token');
			if (access_token)
			{
				const options = { 
					method: 'DELETE',
					// headers: { "Authorization": "Bearer " + access_token } // only needed when JWT is not in cookie
				};
				fetch( '/blogposts/{{ contentPost.id }}', options )
					.then( response => response.json() )
					.then( response => {
						// Do something with response:
						console.log( response )
						if (response.id != '{{ contentPost.id }}')
						{ 
							console.log( "DELETE ERROR!" )
							alert( "DELETE ERROR!" )
							
						}
						window.location.href = "/";

					} ); 
			}
			else { alert("Not Authorized.") }
		}

		function Logout() { 
			localStorage.removeItem('token');
			// document.cookie = 'access_token=; Max-Age=0; path=/; domain=' + location.host; // don't work
			const options = { method: 'POST', body: {} };
			fetch("/users/logout", options)
				.then((response) => {
					if (!response.ok) {
						throw new Error('Network response was not OK');
				  	}
					return response.json();
				})
				.then( response => 
					{
						console.log(response)
						if (response.hasOwnProperty('username')) {
							window.location.href = "/login"; 
						}
				  	})
		}

	</script>
</body>
</html>
